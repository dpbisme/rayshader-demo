<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="radix" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

  <!--radix_placeholder_meta_tags-->
  <title>I can rayshade, and so can you</title>
  
  <meta property="description" itemprop="description" content="A beginner&#39;s tour to making custom maps with `rayshader` in R."/>
  
  <link rel="license" href="https://creativecommons.org/licenses/by/4.0/"/>
  
  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2019-02-07"/>
  <meta property="article:created" itemprop="dateCreated" content="2019-02-07"/>
  <meta name="article:author" content="Will Bishop"/>
  
  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="I can rayshade, and so can you"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="A beginner&#39;s tour to making custom maps with `rayshader` in R."/>
  <meta property="og:image" content="https://wcmbishop.github.io/rayshader-demo/images/sf-2D-overlay.png"/>
  <meta property="og:image:width" content="600"/>
  <meta property="og:image:height" content="475"/>
  <meta property="og:locale" content="en_US"/>
  
  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary_large_image"/>
  <meta property="twitter:title" content="I can rayshade, and so can you"/>
  <meta property="twitter:description" content="A beginner&#39;s tour to making custom maps with `rayshader` in R."/>
  <meta property="twitter:image" content="https://wcmbishop.github.io/rayshader-demo/images/sf-2D-overlay.png"/>
  <meta property="twitter:image:width" content="600"/>
  <meta property="twitter:image:height" content="475"/>
  <meta property="twitter:site" content="@rstudio"/>
  <meta property="twitter:creator" content="@fly_upside_down"/>
  
  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","output","repository_url","base_url","preview","creative_commons","twitter"]}},"value":[{"type":"character","attributes":{},"value":["I can rayshade, and so can you"]},{"type":"character","attributes":{},"value":["A beginner's tour to making custom maps with `rayshader` in R.\n"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url","affiliation","affiliation_url"]}},"value":[{"type":"character","attributes":{},"value":["Will Bishop"]},{"type":"character","attributes":{},"value":["https://www.github.com/wcmbishop"]},{"type":"character","attributes":{},"value":["twitter @wcmbishop"]},{"type":"character","attributes":{},"value":["https://twitter.com/wcmbishop"]}]}]},{"type":"character","attributes":{},"value":["2019-02-07"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["radix::radix_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["toc","toc_depth","self_contained"]}},"value":[{"type":"logical","attributes":{},"value":[true]},{"type":"integer","attributes":{},"value":[3]},{"type":"logical","attributes":{},"value":[false]}]}]},{"type":"character","attributes":{},"value":["https://www.github.com/wcmbishop/rayshader-demo"]},{"type":"character","attributes":{},"value":["https://wcmbishop.github.io/rayshader-demo"]},{"type":"character","attributes":{},"value":["images/sf-2D-overlay.png"]},{"type":"character","attributes":{},"value":["CC BY"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["site","creator"]}},"value":[{"type":"character","attributes":{},"value":["@rstudio"]},{"type":"character","attributes":{},"value":["@fly_upside_down"]}]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["data/dem_01.tif","data/sf-elevation.tif","data-raw/download-demo-file.R","data-raw/generate-montereybay-gif.R","data-raw/sample-sf-images.R","images/monetereybay-3D.png","images/montereybay.gif","images/raylogosmall.png","images/sf-2D-overlay.png","images/sf-2D.png","images/sf-3D-overlay-label.png","images/sf-3D-overlay.png","images/sf-flyby.gif","images/sf-map.png","images/sf-satellite.png","images/sf-street.png","images/sf-topo.png","images/sutro-tower.jpg","index_files/bowser-1.9.3/bowser.min.js","index_files/distill-2.2.21/template.v2.js","index_files/figure-html5/2D-map-1.png","index_files/figure-html5/load-elevation-1.png","index_files/figure-html5/rayshader-2D-overlay-1.png","index_files/figure-html5/rayshader-3D-overlay-label-1.png","index_files/figure-html5/unnamed-chunk-28-1.png","index_files/figure-html5/unnamed-chunk-5-1.png","index_files/figure-html5/unnamed-chunk-7-1.png","index_files/htmlwidgets-1.3/htmlwidgets.js","index_files/jquery-1.12.4/jquery.min.js","index_files/leaflet-1.3.1/images/layers-2x.png","index_files/leaflet-1.3.1/images/layers.png","index_files/leaflet-1.3.1/images/marker-icon-2x.png","index_files/leaflet-1.3.1/images/marker-icon.png","index_files/leaflet-1.3.1/images/marker-shadow.png","index_files/leaflet-1.3.1/leaflet.css","index_files/leaflet-1.3.1/leaflet.js","index_files/leaflet-binding-2.0.2/leaflet.js","index_files/leafletfix-1.0.0/leafletfix.css","index_files/Proj4Leaflet-1.0.1/proj4-compressed.js","index_files/Proj4Leaflet-1.0.1/proj4leaflet.js","index_files/rstudio_leaflet-1.3.1/images/1px.png","index_files/rstudio_leaflet-1.3.1/rstudio_leaflet.css","index_files/webcomponents-2.0.0/webcomponents.js","index.html","R/elevation-api.R","R/find-image-coordinates.R","R/image-size.R","R/map-image-api.R","R/rayshader-gif.R","R/read-elevation.R"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->
  
  <style type="text/css">
  
  body {
    background-color: white;
  }
  
  .pandoc-table {
    width: 100%;
  }
  
  .pandoc-table>caption {
    margin-bottom: 10px;
  }
  
  .pandoc-table th:not([align]) {
    text-align: left;
  }
  
  .pagedtable-footer {
    font-size: 15px;
  }
  
  .html-widget {
    margin-bottom: 2.0em;
  }
  
  .l-screen-inset {
    padding-right: 16px;
  }
  
  .l-screen .caption {
    margin-left: 10px;
  }
  
  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .shaded-content {
    background: white;
  }
  
  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }
  
  .hidden {
    display: none !important;
  }
  
  d-article {
    padding-bottom: 30px;
  }
  
  d-appendix {
    padding-top: 30px;
  }
  
  d-article>p>img {
    width: 100%;
  }
  
  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }
  
  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  /* CSS for table of contents */
  
  .d-toc {
    color: rgba(0,0,0,0.8);
    font-size: 0.8em;
    line-height: 1em;
  }
  
  .d-toc-header {
    font-size: 0.6rem;
    font-weight: 400;
    color: rgba(0, 0, 0, 0.5);
    text-transform: uppercase;
    margin-top: 0;
    margin-bottom: 1.3em;
  }
  
  .d-toc a {
    border-bottom: none;
  }
  
  .d-toc ul {
    padding-left: 0;
  }
  
  .d-toc li>ul {
    padding-top: 0.8em;
    padding-left: 16px;
    margin-bottom: 0.6em;
  }
  
  .d-toc ul,
  .d-toc li {
    list-style-type: none;
  }
  
  .d-toc li {
    margin-bottom: 0.9em;
  }
  
  .d-toc-separator {
    margin-top: 20px;
    margin-bottom: 2em;
  }
  
  .d-article-with-toc {
    border-top: none;
    padding-top: 0;
  }
  
  
  
  /* Tweak code blocks (note that this CSS is repeated above in an injection
     into the d-code shadow dom) */
  
  d-code {
    overflow-x: auto !important;
  }
  
  pre.d-code code.d-code {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }
  
  pre.text-output {
  
    font-size: 12px;
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  @media(min-width: 768px) {
  
  d-code {
    overflow-x: visible !important;
  }
  
  pre.d-code code.d-code  {
      padding-left: 18px;
      font-size: 14px;
  }
  pre.text-output {
    font-size: 14px;
  }
  }
  
  /* Figure */
  
  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }
  
  .figure img {
    width: 100%;
  }
  
  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }
  
  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }
  
  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }
  
  
  
  /* Tweak 1000px media break to show more text */
  
  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }
  
    .grid {
      grid-column-gap: 16px;
    }
  
    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }
  
  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }
  
    .grid {
      grid-column-gap: 32px;
    }
  }
  
  
  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */
  
  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  
  /* Social footer */
  
  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }
  
  .disqus-comments {
    margin-right: 30px;
  }
  
  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }
  
  #disqus_thread {
    margin-top: 30px;
  }
  
  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }
  
  .article-sharing a:hover {
    border-bottom: none;
  }
  
  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }
  
  .subscribe p {
    margin-bottom: 0.5em;
  }
  
  
  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }
  
  
  /* Improve display for browsers without grid (IE/Edge <= 15) */
  
  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }
  
  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }
  
  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }
  
  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }
  
  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }
  
  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }
  
  
  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }
  
  .downlevel .footnotes ol {
    padding-left: 13px;
  }
  
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }
  
  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }
  
  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }
  
  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  </style>
  
  <script type="application/javascript">
  
  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }
  
  // show body when load is complete
  function on_load_complete() {
  
    // set body to visible
    document.body.style.visibility = 'visible';
  
    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }
  
    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }
  
  function init_distill() {
  
    init_common();
  
    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);
  
    // create d-title
    $('.d-title').changeElementType('d-title');
  
    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);
  
    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();
  
    // move posts container into article
    $('.posts-container').appendTo($('d-article'));
  
    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');
  
    // create d-bibliography
    var bibliography = $('<d-bibliography></d-bibliography>');
    $('#distill-bibliography').wrap(bibliography);
  
    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;
  
    // replace citations with <d-cite>
    $('.citation').each(function(i, val) {
      appendix = true;
      var cites = $(this).attr('data-cites').split(" ");
      var dt_cite = $('<d-cite></d-cite>');
      dt_cite.attr('key', cites.join());
      $(this).replaceWith(dt_cite);
    });
    // remove refs
    $('#refs').remove();
  
    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();
  
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-toc a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });
  
    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');
  
    // replace code blocks with d-code
    $('pre>code').each(function(i, val) {
      var code = $(this);
      var pre = code.parent();
      var clz = "";
      var language = pre.attr('class');
      if (language) {
        // map unknown languages to "clike" (without this they just dissapear)
        if ($.inArray(language, ["bash", "clike", "css", "go", "html",
                                 "javascript", "js", "julia", "lua", "markdown",
                                 "markup", "mathml", "python", "svg", "xml"]) == -1)
          language = "clike";
        language = ' language="' + language + '"';
        var dt_code = $('<d-code block' + language + clz + '></d-code>');
        dt_code.text(code.text());
        pre.replaceWith(dt_code);
      } else {
        code.addClass('text-output').unwrap().changeElementType('pre');
      }
    });
  
    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {
  
      // capture layout
      var layout = $(this).attr('data-layout');
  
      // apply layout to markdown level block elements
      var elements = $(this).children().not('d-code, pre.text-output, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });
  
  
      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });
  
    // load distill framework
    load_distill_framework();
  
    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {
  
      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;
  
      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');
  
      // table of contents
      if (have_authors) // adjust border if we are in authors
        $('.d-toc').parent().addClass('d-article-with-toc');
  
      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');
  
      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }
  
      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');
  
      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");
  
      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }
  
       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }
  
      // inject pre code styles (can't do this with a global stylesheet b/c a shadow root is used)
      $('d-code').each(function(i, val) {
        var style = document.createElement('style');
        style.innerHTML = 'pre code { padding-left: 10px; font-size: 12px; border-left: 2px solid rgba(0,0,0,0.1); } ' +
                          '@media(min-width: 768px) { pre code { padding-left: 18px; font-size: 14px; } }';
        if (this.shadowRoot)
          this.shadowRoot.appendChild(style);
      });
  
      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();
  
      // clear polling timer
      clearInterval(tid);
  
      // show body now that everything is ready
      on_load_complete();
    }
  
    var tid = setInterval(distill_post_process, 50);
    distill_post_process();
  
  }
  
  function init_downlevel() {
  
    init_common();
  
     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));
  
    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
  
    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();
  
    // remove toc
    $('.d-toc-header').remove();
    $('.d-toc').remove();
    $('.d-toc-separator').remove();
  
    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });
  
  
    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);
  
    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);
  
    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();
  
    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();
  
    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));
  
    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });
  
    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));
  
    $('body').addClass('downlevel');
  
    on_load_complete();
  }
  
  
  function init_common() {
  
    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};
  
        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });
  
        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);
  
    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});
  
    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });
  
      }
    });
  
    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });
  
    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.radix-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }
  
    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');
  
    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");
  
    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();
  
    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });
  
  </script>
  
  <!--/radix_placeholder_distill-->
  <script src="index_files/htmlwidgets-1.3/htmlwidgets.js"></script>
  <script src="index_files/jquery-1.12.4/jquery.min.js"></script>
  <link href="index_files/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
  <script src="index_files/leaflet-1.3.1/leaflet.js"></script>
  <link href="index_files/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
  <script src="index_files/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
  <script src="index_files/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
  <link href="index_files/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
  <script src="index_files/leaflet-binding-2.0.2/leaflet.js"></script>
  <script src="index_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="index_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="index_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"I can rayshade, and so can you","description":"A beginner's tour to making custom maps with `rayshader` in R.","authors":[{"author":"Will Bishop","authorURL":"https://www.github.com/wcmbishop","affiliation":"twitter @wcmbishop","affiliationURL":"https://twitter.com/wcmbishop"}],"publishedDate":"2019-02-07T00:00:00.000-08:00","citationText":"Bishop, 2019"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>I can rayshade, and so can you</h1>
<p>A beginner’s tour to making custom maps with <code>rayshader</code> in R.</p>
</div>

<div class="d-byline">
  Will Bishop <a href="https://www.github.com/wcmbishop" class="uri">https://www.github.com/wcmbishop</a> (twitter <span class="citation" data-cites="wcmbishop">@wcmbishop</span>)<a href="https://twitter.com/wcmbishop" class="uri">https://twitter.com/wcmbishop</a>
  
<br/>2019-02-07
</div>

<div class="d-article">
<h3 class="d-toc-header">Table of Contents</h3>
<nav class="d-toc" id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#selecting-a-region">Selecting a Region</a></li>
<li><a href="#downloading-elevation-data">Downloading Elevation Data</a><ul>
<li><a href="#sr-spatial-reference">SR: Spatial Reference</a></li>
<li><a href="#plotting-my-own-map">Plotting <em>My Own Map™</em></a></li>
</ul></li>
<li><a href="#overlaying-map-images">Overlaying Map Images</a><ul>
<li><a href="#d-map-overlays">2D Map Overlays</a></li>
<li><a href="#d-map-overlays-1">3D Map Overlays</a></li>
</ul></li>
<li><a href="#into-the-4th-dimension---gifs">Into the 4th Dimension - GIFs</a><ul>
<li><a href="#one-can-simply-gif">One can simply gif</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#afterthoughts">Afterthoughts</a></li>
<li><a href="#acknowledgments">Acknowledgments</a></li>
</ul>
</nav>
<hr class="d-toc-separator"/>
<h1 id="introduction">Introduction</h1>
<p>Last month in January, I attended the wonderful <a href="https://www.rstudio.com/conference/">rstudio::conf 2019</a> in Austin, TX. One of the most interesting (and entertaining) presentations I saw at the conference was by <a href="https://twitter.com/tylermorganwall">Tyler Morgan-Wall</a>, talking about his magical <code>rayshader</code> package<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. From Tyler’s <a href="https://www.rayshader.com">rayshader website</a>:</p>
<aside>
<div class="layout-chunk" data-layout="l-body">
<p><img src="images/raylogosmall.png" width="61" /></p>
</div>
</aside>
<blockquote>
<p>rayshader is an open source R package for producing 2D and 3D hillshaded maps of elevation matrices using a combination of raytracing, spherical texture mapping, overlays, and ambient occlusion.</p>
</blockquote>
<p>Basically, <code>rayshader</code> makes maps – <em>beautiful</em> 2D and 3D maps, built from raw elevation data. Like this one of Monterey Bay, using the code below:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(rayshader)

montereybay %&gt;%
  sphere_shade(zscale = 10, texture = &quot;imhof1&quot;) %&gt;%
  add_shadow(ray_shade(montereybay, zscale = 50)) %&gt;%
  add_shadow(ambient_shade(montereybay, zscale = 50)) %&gt;%
  plot_3d(montereybay, zscale = 50, theta = -45, phi = 45, water = TRUE,
          windowsize = c(1000,800), zoom = 0.75, waterlinealpha = 0.3,
          wateralpha = 0.5, watercolor = &quot;lightblue&quot;, waterlinecolor = &quot;white&quot;)
render_snapshot()</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<p><img src="images/monetereybay-3D.png" width="500" /></p>
</div>
<p>I had seen images from <code>rayshader</code> floating around on Twitter, but it was amazing to get a (meme-filled) tour of the features from the package creator. I was inspired to try it out! I got up and running quickly with the package documentation, and I was spinning 3D plots of the included <code>montereybay</code> dataset in no time. But then I was stuck. How do I make my own maps from my own regions? How do I add those nice image overlays? And how do I make those amazing gifs?!</p>
<p>You see, I’m an “un-educated” <code>rayshader</code> user – I don’t know much about maps. Where do I get elevation data? What the heck is a <code>.tif</code>? Where can I download map images? How does one simply gif? The <code>rayshader</code> package falls on the right side of “magic” for the most part, but I found the documentation for these sorts of beginner questions lacking. So after stumbling through the darkness for a while and learning some things, I wrote this article for users like me, to help answer those questions. <strong>I can <code>rayshader</code> and so can you</strong><a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>!</p>
<p>For this article, I’m using the latest dev version of <code>rayshader</code> from GitHub (version 0.9.1 at the time of writing), which is significantly faster than the version on CRAN. You can download this version with the code below. Many of the code-snippets in this article also use custom functions I wrote for this post. All these functions are available in the <a href="https://github.com/wcmbishop/rayshader-demo">git source repo</a>, under the <code>R</code> folder.<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a> Now…let’s get mapping.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# To install the latest version from Github:
# install.packages(&quot;devtools&quot;)
devtools::install_github(&quot;tylermorganwall/rayshader&quot;)</code></pre>
</div>
<h1 id="selecting-a-region">Selecting a Region</h1>
<p>The first step in making My Own Map™ is to pick out a region. To keep it simple, let’s stick with just a plain rectangular “bounding box” of somewhere in the world. I live in the Bay Area, so I thought I’d try out San Francisco to start with. Originally, I wanted to have a nice UI to manually draw a region on an interactive map…but that seemed hard. Instead, I settled on manually iterating on a set of longitude/latitude coordinates and displaying them in a map using the <a href="https://rstudio.github.io/leaflet/"><code>leaflet</code></a> package. The code and map below shows my selected bounding box for San Francisco.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(leaflet)

# define bounding box with longitude/latitude coordinates
bbox &lt;- list(
  p1 = list(long = -122.522, lat = 37.707),
  p2 = list(long = -122.354, lat = 37.84)
)

leaflet() %&gt;%
  addTiles() %&gt;% 
  addRectangles(
    lng1 = bbox$p1$long, lat1 = bbox$p1$lat,
    lng2 = bbox$p2$long, lat2 = bbox$p2$lat,
    fillColor = &quot;transparent&quot;
  ) %&gt;%
  fitBounds(
    lng1 = bbox$p1$long, lat1 = bbox$p1$lat,
    lng2 = bbox$p2$long, lat2 = bbox$p2$lat,
  )</code></pre>
<div id="htmlwidget-a4953b48bd2644e12923" style="width:624px;height:384px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-a4953b48bd2644e12923">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"http://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"http://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addRectangles","args":[37.707,-122.522,37.84,-122.354,null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"transparent","fillOpacity":0.2,"smoothFactor":1,"noClip":false},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[37.707,37.84],"lng":[-122.522,-122.354]},"fitBounds":[37.707,-122.522,37.84,-122.354,[]]},"evals":[],"jsHooks":[]}</script>
</div>
<p>Next is a small but important step. We need to define an <strong>image size</strong> to use based on our selected bounding box coordinates. Both our elevation data and our map overlay will be downloaded as image files. For our <code>rayshader</code> maps to work, two things are required:</p>
<ol type="1">
<li>the image dimensions need to match our bounding box coordinates (i.e have the same aspect ratio)</li>
<li>the images dimensions of the elevation data and map overlay need to match exactly (i.e. produce the same size arrays)</li>
</ol>
<p>The function below calculates an image size to use in the rest of our code, with the results shown in json. We also control the overall size of the image by defining the major dimension (e.g. <code>600</code> pixels, which sets the large image dimension). Larger sizes will download more elevation data and make bigger maps.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
image_size &lt;- define_image_size(bbox, major_dim = 600)</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<pre><code>
{
  &quot;height&quot;: 475,
  &quot;width&quot;: 600,
  &quot;size&quot;: &quot;600,475&quot;
} </code></pre>
</div>
<h1 id="downloading-elevation-data">Downloading Elevation Data</h1>
<p>Next we need to download some elevation data for our selected map region. This was probably the most difficult and intimidating part of this whole effort. As a person who is new to maps and layers and GIS and such, I had no idea where to start (and this field is <em>deep</em>). There are probably numerous great options out there<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>, but I generally found them either confusing or costly.</p>
<p>I wanted something <strong>free</strong> and <strong>programmatic</strong>. And the good news is, if you are looking for map regions in North America, there is an API for you! The USGS hosts a National Map tool that can export elevation data via a <a href="https://elevation.nationalmap.gov/arcgis/rest/services/3DEPElevation/ImageServer/exportImage?bbox=-122.522%2C37.707%2C-122.354%2C37.84&amp;bboxSR=4326&amp;size=600%2C480&amp;imageSR=4326&amp;time=&amp;format=jpgpng&amp;pixelType=F32&amp;noData=&amp;noDataInterpretation=esriNoDataMatchAny&amp;interpolation=+RSP_BilinearInterpolation&amp;compression=&amp;compressionQuality=&amp;bandIds=&amp;mosaicRule=&amp;renderingRule=&amp;f=html">web UI here</a>, and they also support a REST API for the same data<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a>.</p>
<p>I wrote the function <code>get_usgs_elevation_data</code> to download elevation data using this API. The code below makes the process look easy! Now we have elevation measurements for our selected region (using our defined image size) in a .tif file, ready to raster (…whatever that means).</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# download elevation data
elev_file &lt;- file.path(&quot;data&quot;, &quot;sf-elevation.tif&quot;)
get_usgs_elevation_data(bbox, size = image_size$size, file = elev_file,
                        sr_bbox = 4326, sr_image = 4326)</code></pre>
</div>
<h3 id="sr-spatial-reference">SR: Spatial Reference</h3>
<p>Before I move on, let’s take a moment to talk about coordinate systems. You may have noticed the two numeric inputs above for <code>sr_bbox</code> and <code>sr_image</code>. The “sr” refers “spatial reference”. Apparently a map is not a map is not a map – how it’s drawn and the measurements it uses depend on its spatial reference system, each identified by an SR code. You can read a great introduction on this topic <a href="https://developers.arcgis.com/documentation/core-concepts/spatial-references/">here</a><a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a>. For this article, I’m using SR 4326, which is the most common GPS coordinate system, where positions are defined in <em>degrees</em> of longitude/latitude (as opposed to say the non-spherical mercator projections of SR 3857 used by the <code>leaflet</code> package).</p>
<h3 id="plotting-my-own-map">Plotting <em>My Own Map™</em></h3>
<p>Now with this downloaded elevation data, I can make my very own map. In the code below, I first read in the elevation <code>.tif</code> file and load it into a 2D elevation matrix – I show the code here for clarity, but this common step can be encapsulated in a function to make this a one-line call (which I’ve done in <code>read_elevation_file</code>). Next is typical <code>rayshader</code> code – I calculate some data layers and then build a 2D plot. I chose to calculate the initial data layers outside of the plot pipeline because I will re-use those pre-calculated layers in subsequent plots.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# load elevation data
elev_img &lt;- raster::raster(elev_file)
elev_matrix &lt;- matrix(
  raster::extract(elev_img, raster::extent(elev_img), buffer = 1000), 
  nrow = ncol(elev_img), ncol = nrow(elev_img)
)

# calculate rayshader layers
ambmat &lt;- ambient_shade(elev_matrix, zscale = 30)
raymat &lt;- ray_shade(elev_matrix, zscale = 30, lambert = TRUE)
watermap &lt;- detect_water(elev_matrix)

# plot 2D
elev_matrix %&gt;%
  sphere_shade(texture = &quot;imhof4&quot;) %&gt;%
  add_water(watermap, color = &quot;imhof4&quot;) %&gt;%
  add_shadow(raymat, max_darken = 0.5) %&gt;%
  add_shadow(ambmat, max_darken = 0.5) %&gt;%
  plot_map()</code></pre>
<p><img src="index_files/figure-html5/load-elevation-1.png" width="624" /></p>
</div>
<h1 id="overlaying-map-images">Overlaying Map Images</h1>
<p>Beautiful! San Francisco: the hilly, desert city by the bay. The vanilla <code>rayshader</code> plots can look striking, but sometimes they appear a bit barren. They are also missing context – e.g. which one of those nobby hills is Nob Hill? Wouldn’t it be nice to have a map overlayed on top of this to get our bearings? Or maybe a satellite image? That’s possible with the <code>rayshader</code> <code>add_overlay</code> function, but the <em>hard</em> part is getting the image. We need an image for the same bounding box region, AND (as mentioned above) the overlay image dimensions need to match our elevation data dimensions exactly.</p>
<p>Good news! Once again, there’s an API for that. ArcGISOnline hosts a web UI for exporting map images <a href="https://utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task/execute">here</a>, and this same url can also be accessed programmatically as a REST API.<a href="#fn7" class="footnote-ref" id="fnref7"><sup>7</sup></a></p>
<p>I wrote the function <code>get_arcgis_map_image</code> to interface with this API endpoint (which is actually a two-step process: one call to generate an image, another call to download the image). Once again, the code below makes this step look easy. You can see our downloaded map image to the right.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# fetch overlay image
overlay_file &lt;- &quot;images/sf-map.png&quot;
get_arcgis_map_image(bbox, map_type = &quot;World_Topo_Map&quot;, file = overlay_file,
                     width = image_size$width, height = image_size$height, 
                     sr_bbox = 4326)
overlay_img &lt;- png::readPNG(overlay_file)</code></pre>
</div>
<aside>
<div class="layout-chunk" data-layout="l-body">
<p><img src="images/sf-map.png" width="300" /></p>
</div>
</aside>
<p>There are several base map types to choose from in the API, which are <a href="https://services.arcgisonline.com/ArcGIS/rest/services">listed here</a> under “Services”. Below are three nice options.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="index_files/figure-html5/unnamed-chunk-5-1.png" width="672" /></p>
</div>
<h3 id="d-map-overlays">2D Map Overlays</h3>
<p>Now that I have a map overlay image (with matching dimensions), I can add that to my <code>rayshader</code> plots. Here is a 2D overlay plot - the new layer <code>add_overlay</code> adds the downloaded map image to the rendered <code>rayshader</code> plot.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# 2D plot with map overlay
elev_matrix %&gt;%
  sphere_shade(texture = &quot;imhof4&quot;) %&gt;%
  add_water(watermap, color = &quot;imhof4&quot;) %&gt;%
  add_shadow(raymat, max_darken = 0.5) %&gt;%
  add_shadow(ambmat, max_darken = 0.5) %&gt;%
  add_overlay(overlay_img, alphalayer = 0.5) %&gt;%
  plot_map()</code></pre>
<p><img src="index_files/figure-html5/rayshader-2D-overlay-1.png" width="624" /></p>
</div>
<h3 id="d-map-overlays-1">3D Map Overlays</h3>
<p>And I can do the same thing with a 3D <code>rayshader</code> plot. Below is a static rendered snapshot, but locally you can interact with the 3D plot and manually spin and zoom to your heart’s content.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
zscale &lt;- 10
rgl::clear3d()
elev_matrix %&gt;% 
  sphere_shade(zscale = zscale, texture = &quot;imhof4&quot;) %&gt;% 
  add_overlay(overlay_img, alphalayer = 0.5) %&gt;%
  add_shadow(raymat, max_darken = 0.5) %&gt;%
  add_shadow(ambmat, max_darken = 0.5) %&gt;%
  plot_3d(elev_matrix, zscale = zscale, windowsize = c(1200, 1000),
          water = FALSE, soliddepth = -max(elev_matrix)/zscale,
          theta = 25, phi = 30, zoom = 0.65, fov = 60)
render_snapshot()</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<p><img src="images/sf-3D-overlay.png" width="600" /></p>
</div>
<p>We can even add map labels to our 3D plot. Here’s a marker for Sutro Tower, added after looking up the GPS coordinates on <a href="https://www.latlong.net">latlong.net</a>. I use the custom function <code>find_image_coordinates</code> to translate the GPS coordinates into an image position.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# figure out the label position
label_pos &lt;- find_image_coordinates(
  long = -122.452131, lat = 37.756735, bbox = bbox,
  image_width = image_size$width, image_height = image_size$height)

# plot 3D
zscale &lt;- 10
rgl::clear3d()
elev_matrix %&gt;% 
  sphere_shade(zscale = zscale, texture = &quot;imhof4&quot;) %&gt;% 
  add_overlay(overlay_img, alphalayer = 0.5) %&gt;%
  add_shadow(raymat, max_darken = 0.5) %&gt;%
  add_shadow(ambmat, max_darken = 0.5) %&gt;%
  plot_3d(elev_matrix, zscale = zscale, windowsize = c(1200, 1000),
          water = FALSE, soliddepth = -max(elev_matrix)/zscale,
          theta = 25, phi = 30, zoom = 0.65, fov = 60)
# add label
render_label(elev_matrix, x = label_pos$x, y = label_pos$y, z = 500, 
             zscale = zscale, text = &quot;Sutro Tower&quot;, textsize = 2, linewidth = 5)
render_snapshot()</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<p><img src="images/sf-3D-overlay-label.png" width="600" /></p>
</div>
<aside>
<div class="layout-chunk" data-layout="l-body">
<div class="figure"><span id="fig:unnamed-chunk-6"></span>
<img src="images/sutro-tower.jpg" alt="Justin Beck [CC BY 2.0](https://creativecommons.org/licenses/by/2.0), via Wikimedia Commons" width="150" />
<p class="caption">
Figure 1: Justin Beck <a href="https://creativecommons.org/licenses/by/2.0">CC BY 2.0</a>, via Wikimedia Commons
</p>
</div>
</div>
</aside>
<h1 id="into-the-4th-dimension---gifs">Into the 4th Dimension - GIFs</h1>
<p>Of course, one of the most eye-popping features of <code>rayshader</code> is the gifs it can make. We loved going from 2D to 3D, so why not animate? <em>People. Love. GIFs.</em> So, let’s make some!</p>
<p>Again this is possible, but I found the documentation on this a bit lacking. A good example is shared in this <a href="https://www.tylermw.com/3d-maps-with-rayshader/">blog post</a> from Tyler Morgan-Wall’s website, and the code below is pulled from that post. Basically, we loop through multiple plots to save individual images with <code>render_snapshot</code>, then we stitch them into a gif with <code>image_write_gif</code> (from the <a href="https://github.com/ropensci/magick"><code>magick</code></a> package). The code is readable and not <em>too</em> long….but what what if there was a simpler way?</p>
<aside>
<div class="layout-chunk" data-layout="l-body">
<p><img src="images/montereybay.gif" /><!-- --></p>
</div>
</aside>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# montery water gif ====
elev_matrix &lt;- montereybay
n_frames &lt;- 180
zscale &lt;- 50
# frame transition variables
waterdepthvalues &lt;- min(elev_matrix)/2 - min(elev_matrix)/2 * cos(seq(0,2*pi,length.out = n_frames))
thetavalues &lt;- -90 + 45 * cos(seq(0, 2*pi, length.out = n_frames))
# shadow layers
ambmat &lt;- ambient_shade(elev_matrix, zscale = zscale)
raymat &lt;- ray_shade(elev_matrix, zscale = zscale, lambert = TRUE)

# generate .png frame images
img_frames &lt;- paste0(&quot;drain&quot;, seq_len(n_frames), &quot;.png&quot;)
for (i in seq_len(frames)) {
  message(paste(&quot; - image&quot;, i, &quot;of&quot;, n_frames))
  elev_matrix %&gt;%
    sphere_shade(texture = &quot;imhof1&quot;, zscale = 10) %&gt;%
    add_shadow(ambmat, 0.5) %&gt;%
    add_shadow(raymat, 0.5) %&gt;%
    plot_3d(elev_matrix, solid = TRUE, shadow = TRUE, zscale = zscale, 
            water = TRUE, watercolor = &quot;imhof3&quot;, wateralpha = 0.8, 
            waterlinecolor = &quot;#ffffff&quot;, waterlinealpha = 0.5,
            waterdepth = waterdepthvalues[i]/zscale, 
            theta = thetavalues[i], phi = 45)
  render_snapshot(img_frames[i])
  rgl::clear3d()
}

# build gif
magick::image_write_gif(magick::image_read(img_frames), 
                        path = &quot;montereybay.gif&quot;, 
                        delay = 6/n_frames)</code></pre>
</div>
<h3 id="one-can-simply-gif">One can simply gif</h3>
<p>But wait! There’s a simpler way to gif, using the new function <code>save_3d_gif</code>. You can pipe in plot layers to this function just like you would with <code>rayshader::plot_3d</code>, with the addition of two new inputs: <code>file</code> (your gif file-path) and <code>duration</code> (your gif duration). But unlike <code>plot_3d</code>, you can pass in any regular input as a vector (e.g. a bunch of <code>theta</code> values to get a rotation). Any vector inputs with lengths &gt;1 will be used to programatically generate intermediate .png images and then create a gif from these. This function is basically generating the same code as shown above, but it’s dynamically made using <a href="https://tidyeval.tidyverse.org">tidy evaluation</a>. The result is the same (e.g. a beautiful gif of Monterey Bay, spinning and draining the water level), but the code is half as long and (hopefully) more readable. This includes using the helper function <code>transition_values</code> to create gif input vectors for the animation frames.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# calculate input vectors for gif frames
n_frames &lt;- 180
waterdepths &lt;- transition_values(from = 0, to = min(montereybay), steps = n_frames) 
thetas &lt;- transition_values(from = -45, to = -135, steps = n_frames)
# generate gif
zscale &lt;- 50
montereybay %&gt;% 
  sphere_shade(texture = &quot;imhof1&quot;, zscale = zscale) %&gt;%
  add_shadow(ambient_shade(montereybay, zscale = zscale), 0.5) %&gt;%
  add_shadow(ray_shade(montereybay, zscale = zscale, lambert = TRUE), 0.5) %&gt;%
  save_3d_gif(montereybay, file = &quot;montereybay.gif&quot;, duration = 6,
              solid = TRUE, shadow = TRUE, water = TRUE, zscale = zscale,
              watercolor = &quot;imhof3&quot;, wateralpha = 0.8, 
              waterlinecolor = &quot;#ffffff&quot;, waterlinealpha = 0.5,
              waterdepth = waterdepths/zscale, 
              theta = thetas, phi = 45)</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<p><img src="images/montereybay.gif" /><!-- --></p>
</div>
<p>Here’s another example, a gratuitous use of angles and zoom to build a San Francisco fly-by.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# gif transition variables
n_frames &lt;- 30
theta &lt;- transition_values(from = 0, to = 360, steps = n_frames, 
                           one_way = TRUE, type = &quot;lin&quot;)
phi &lt;- transition_values(from = 10, to = 70, steps = n_frames, 
                         one_way = FALSE, type = &quot;cos&quot;)
zoom &lt;- transition_values(from = 0.4, to = 0.8, steps = n_frames, 
                         one_way = FALSE, type = &quot;cos&quot;)

# GIF it!
zscale &lt;- 10
elev_matrix %&gt;% 
  sphere_shade(zscale = zscale, texture = &quot;imhof4&quot;) %&gt;% 
  add_water(watermap, color = &quot;imhof4&quot;) %&gt;%
  add_overlay(overlay_img, alphalayer = 0.5) %&gt;%
  add_shadow(raymat, 0.4) %&gt;%
  add_shadow(ambmat, 0.4) %&gt;%
  save_3d_gif(elev_matrix, file = &quot;images/sf-flyby.gif&quot;, duration = 4,
              zscale = zscale, windowsize = c(1200, 1000),
              water = FALSE, soliddepth = -max(elev_matrix)/zscale,
              theta = theta, phi = phi, zoom = zoom, fov = 60)</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<p><img src="images/sf-flyby.gif" /><!-- --></p>
</div>
<h1 id="conclusion">Conclusion</h1>
<p>Well that’s all I’ve got. I hope you learned something that may save you a bit of pain and confusion if you try out <code>rayshader</code> for yourself. And maybe you’re coming away with just a bit more excitement and inspiration to do so. I’ve certainly enjoyed my time with this package, and I’ll be making more maps in the future (as well as 3D printing some). Thanks for reading.</p>
<h1 id="afterthoughts">Afterthoughts</h1>
<p>After writing this post, I found a few more leads on elevation data sources. I thought I’d share these here (though I think the REST API option I described above is still a great starting place).</p>
<p>One is the <code>elevatr</code> R package (<a href="https://cran.r-project.org/web/packages/elevatr/vignettes/introduction_to_elevatr.html#usgs_elevation_point_query_service">vignette here</a>), which uses the National Map <a href="http://ned.usgs.gov/epqs/">Elevation Point Query Service</a>.</p>
<p>Tyler Morgan-Wall also posted some instructions for manually downloading elevation data from a National Map UI <a href="https://viewer.nationalmap.gov/basic/?basemap=b1&amp;category=ned,nedsrc&amp;title=3DEP%20View">here</a> – the instructions from this <a href="https://www.reddit.com/r/dataisbeautiful/comments/950vzg/visualizing_3d_maps_with_r_what_it_looks_like/">reddit post</a> are quoted below:</p>
<blockquote>
<p>Select File Format: IMG, and then zoom into where you want data. Click the big blue FIND PRODUCTS button at the top. In the Elevation Products (3DEP) pane, click the “results” link to expand the available topographic data available. Then click “Show Footprints” to show the areas that have data, and just hover over the area you want. It should give you a name like “n39w077”–find that in the results pane, and then click the download button. You should download a zip of an IMG file that should contain your data.<br />
Then just load your data locally with the raster package:</p>
<pre><code>
data = raster::raster(&quot;sampledata.img&quot;)
ready_to_use_data = matrix(
raster::extract(data,
raster::extent(data), buffer=10000), nrow=ncol(data), ncol=nrow(data)
)</code></pre>
</blockquote>
<h1 id="acknowledgments" class="appendix">Acknowledgments</h1>
<p>This article was built with <a href="https://rstudio.github.io/radix">Radix</a> - thanks <a href="https://www.rstudio.com">RStudio</a>!.</p>
<p>And thanks for Tyler Morgan-Wall for creating the joyous <a href="https://www.rayshader.com"><code>rayshader</code></a> package.</p>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>You can watch Tyler Morgan-Wall’s full rstudio::conf 2019 presentation <a href="https://resources.rstudio.com/rstudio-conf-2019/3d-mapping-plotting-and-printing-with-rayshader">online here</a><a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>Spoiler, I still don’t know what a .tif is, but I’m still putting them to good use now.<a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p>You can find the source code for this article, including all custom R functions (under the <code>R</code> folder), in the <a href="https://github.com/wcmbishop/rayshader-demo">git repo here</a>.<a href="#fnref3" class="footnote-back">↩</a></p></li>
<li id="fn4"><p>Two seemingly nice paid mapping tools, with some level of free content, are <a href="https://www.mapbox.com">MapBox</a> and <a href="https://www.planet.com">Planet</a><a href="#fnref4" class="footnote-back">↩</a></p></li>
<li id="fn5"><p>You can find the USGS elevation data online <a href="https://elevation.nationalmap.gov/arcgis/rest/services/3DEPElevation/ImageServer/exportImage">here</a>, and there is good documentation on the ArcGIS REST API <a href="https://developers.arcgis.com/rest/services-reference/export-image.htm">here</a><a href="#fnref5" class="footnote-back">↩</a></p></li>
<li id="fn6"><p>Read about Spatial Reference systems for mapping on the ArcGIS website <a href="https://developers.arcgis.com/documentation/core-concepts/spatial-references/">here</a><a href="#fnref6" class="footnote-back">↩</a></p></li>
<li id="fn7"><p>You can generate map images at arcgisonline.com via a web UI <a href="https://utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task/execute">here</a>, and there is good documentation on this ArcGIS REST API endpoint <a href="https://developers.arcgis.com/rest/services-reference/export-web-map-task.htm">here</a>.<a href="#fnref7" class="footnote-back">↩</a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
<h3 id="updates-and-corrections">Corrections</h3>
<p>If you see mistakes or want to suggest changes, please <a href="https://www.github.com/wcmbishop/rayshader-demo/issues/new">create an issue</a> on the source repository.</p>
<h3 id="reuse">Reuse</h3>
<p>Text and figures are licensed under Creative Commons Attribution <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>. Source code is available at <a href="https://www.github.com/wcmbishop/rayshader-demo">https://www.github.com/wcmbishop/rayshader-demo</a>, unless otherwise noted. The figures that have been reused from other sources don't fall under this license and can be recognized by a note in their caption: "Figure from ...".</p>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
